---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.18.0
  name: infras.hostedcluster.densityops.com
spec:
  group: hostedcluster.densityops.com
  names:
    kind: Infra
    listKind: InfraList
    plural: infras
    shortNames:
    - infra
    singular: infra
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - description: Ready status
      jsonPath: .status.conditions[?(@.type=='Ready')].status
      name: Ready
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: Infra is the Schema for the infras API.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: InfraSpec defines the desired state of Infra.
            properties:
              appsIngress:
                description: AppsIngress defines optional configuration for hosted
                  cluster *.apps ingress handling.
                properties:
                  baseDomain:
                    description: |-
                      BaseDomain is the base domain for the hosted cluster's apps ingress.
                      Example: "apps.example.com" where *.apps.<cluster>.apps.example.com will be routable.
                    type: string
                  enabled:
                    default: false
                    description: Enabled determines whether apps ingress automation
                      should be deployed.
                    type: boolean
                  hostedClusterRef:
                    description: HostedClusterRef references the HostedCluster for
                      which apps ingress is being configured.
                    properties:
                      name:
                        description: Name is the name of the HostedCluster.
                        type: string
                      namespace:
                        default: clusters
                        description: Namespace is the namespace of the HostedCluster.
                        type: string
                    required:
                    - name
                    type: object
                  metallb:
                    description: MetalLB contains configuration for the user-managed
                      MetalLB installation.
                    properties:
                      addressPoolName:
                        description: |-
                          AddressPoolName is the MetalLB address pool name to use for the LoadBalancer service.
                          Example: "lab-network"
                        type: string
                      ipAddressPoolRange:
                        description: |-
                          IPAddressPoolRange defines the valid range of IPs expected to be allocated by MetalLB.
                          Format: "start-end" or "start/prefix" notation.
                          This is for documentation/validation purposes only; not enforced by the operator.
                          Example: "10.202.64.221-10.202.64.240"
                        type: string
                      l2AdvertisementName:
                        description: L2AdvertisementName is the MetalLB L2Advertisement
                          resource name.
                        type: string
                    type: object
                  ports:
                    description: Ports defines the HTTP/HTTPS ports for the ingress.
                    properties:
                      http:
                        default: 80
                        description: HTTP port number.
                        format: int32
                        maximum: 65535
                        minimum: 1
                        type: integer
                      https:
                        default: 443
                        description: HTTPS port number.
                        format: int32
                        maximum: 65535
                        minimum: 1
                        type: integer
                    type: object
                  service:
                    description: Service defines the LoadBalancer service to be created
                      in the hosted cluster.
                    properties:
                      name:
                        default: oooi-ingress
                        description: Name is the name of the LoadBalancer service
                          in the hosted cluster.
                        type: string
                      namespace:
                        description: |-
                          Namespace is the namespace where the service will be created.
                          Default: "clusters-<hostedcluster-name>"
                        type: string
                    type: object
                type: object
              infraComponents:
                description: |-
                  InfraComponents defines the configuration for infrastructure services
                  (DHCP, DNS, Proxy) that bridge the isolated VLAN to the control plane.
                properties:
                  dhcp:
                    description: DHCP configuration for dynamic IP assignment to tenant
                      VMs.
                    properties:
                      enabled:
                        default: true
                        description: Enabled determines whether the DHCP server should
                          be deployed.
                        type: boolean
                      image:
                        description: Image is the container image for the DHCP server.
                        type: string
                      leaseTime:
                        default: 1h
                        description: LeaseTime is the DHCP lease duration (e.g., "1h",
                          "24h").
                        type: string
                      rangeEnd:
                        description: RangeEnd is the end of the DHCP IP address pool.
                        type: string
                      rangeStart:
                        description: RangeStart is the beginning of the DHCP IP address
                          pool.
                        type: string
                      serverIP:
                        description: |-
                          ServerIP is the static IP address assigned to the DHCP server pod
                          on the secondary network. Must be within the NetworkConfig CIDR.
                        type: string
                    type: object
                  dns:
                    description: DNS configuration for split-horizon CoreDNS service.
                    properties:
                      baseDomain:
                        description: |-
                          BaseDomain is the base domain for the hosted cluster (e.g., "example.com").
                          Used to construct FQDNs for API server and routes.
                        type: string
                      clusterName:
                        description: |-
                          ClusterName is the name of the hosted cluster.
                          Used to construct FQDNs (e.g., "api.<clusterName>.<baseDomain>").
                        type: string
                      enabled:
                        default: true
                        description: Enabled determines whether the DNS server should
                          be deployed.
                        type: boolean
                      image:
                        description: Image is the container image for CoreDNS.
                        type: string
                      serverIP:
                        description: |-
                          ServerIP is the static IP address assigned to the CoreDNS pod
                          on the secondary network. Must be within the NetworkConfig CIDR.
                        type: string
                    type: object
                  proxy:
                    description: Proxy configuration for Envoy L4 proxy gateway.
                    properties:
                      apiServerService:
                        default: kube-apiserver
                        description: |-
                          APIServerService is the name of the Kubernetes API server service
                          in the control plane namespace.
                        type: string
                      controlPlaneNamespace:
                        description: |-
                          ControlPlaneNamespace is the namespace where the hosted control plane
                          services are running (e.g., "clusters-<clustername>").
                        type: string
                      enabled:
                        default: true
                        description: Enabled determines whether the Envoy proxy should
                          be deployed.
                        type: boolean
                      internalProxyService:
                        description: |-
                          InternalProxyService is the internal proxy service for pod network access.
                          Can be a ClusterIP service name (e.g., "envoy-internal.namespace.svc.cluster.local")
                          or a ClusterIP address. Used by DNS default view for management cluster pod access.
                        type: string
                      managerImage:
                        default: quay.io/cldmnky/oooi:latest
                        description: ManagerImage is the container image for the xDS
                          control plane (oooi).
                        type: string
                      proxyImage:
                        default: envoyproxy/envoy:v1.36.4
                        description: ProxyImage is the container image for Envoy proxy.
                        type: string
                      serverIP:
                        description: |-
                          ServerIP is the static IP address assigned to the Envoy proxy pod
                          on the secondary network. Must be within the NetworkConfig CIDR.
                          This is used for external access (VM/multus network).
                        type: string
                    type: object
                type: object
              networkConfig:
                description: |-
                  NetworkConfig defines the secondary network (VLAN) configuration
                  for the hosted cluster's isolated network.
                properties:
                  cidr:
                    description: |-
                      CIDR is the IP address range for the secondary network in CIDR notation.
                      Example: "192.168.100.0/24"
                    pattern: ^(?:[0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$
                    type: string
                  dnsServers:
                    description: |-
                      DNSServers is an optional list of upstream DNS servers for external resolution.
                      If not specified, the infrastructure DNS will use the pod's default resolvers.
                    items:
                      type: string
                    type: array
                  gateway:
                    description: |-
                      Gateway is the default gateway IP address for the secondary network.
                      Example: "192.168.100.1"
                    pattern: ^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$
                    type: string
                  networkAttachmentDefinition:
                    description: |-
                      NetworkAttachmentDefinition is the name of the Multus NetworkAttachmentDefinition
                      that represents the secondary VLAN.
                    minLength: 1
                    type: string
                  networkAttachmentNamespace:
                    description: |-
                      NetworkAttachmentNamespace is the namespace where the NetworkAttachmentDefinition resides.
                      If not specified, the operator will look for the NAD first in the current namespace,
                      then in the default namespace.
                    type: string
                required:
                - cidr
                - gateway
                - networkAttachmentDefinition
                type: object
            required:
            - networkConfig
            type: object
          status:
            description: InfraStatus defines the observed state of Infra.
            properties:
              appsIngressStatus:
                description: AppsIngressStatus tracks the status of apps ingress configuration.
                properties:
                  externalIP:
                    description: ExternalIP is the external IP assigned by MetalLB
                      to the hosted cluster's LoadBalancer service.
                    type: string
                  lastSyncTime:
                    description: LastSyncTime is the timestamp of the last successful
                      reconciliation.
                    format: date-time
                    type: string
                  message:
                    description: Message provides a human-readable message explaining
                      the current status.
                    type: string
                  phase:
                    description: |-
                      Phase represents the current phase of apps ingress provisioning.
                      Possible values: Pending, Ready, Degraded
                    type: string
                  reason:
                    description: Reason provides a short reason for the current phase.
                    type: string
                type: object
              componentStatus:
                description: ComponentStatus tracks the status of individual infrastructure
                  components.
                properties:
                  dhcpReady:
                    description: DHCPReady indicates whether the DHCP server is ready.
                    type: boolean
                  dnsReady:
                    description: DNSReady indicates whether the CoreDNS server is
                      ready.
                    type: boolean
                  proxyReady:
                    description: ProxyReady indicates whether the Envoy proxy is ready.
                    type: boolean
                type: object
              conditions:
                description: Conditions represents the latest available observations
                  of the Infra's state.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              observedGeneration:
                description: ObservedGeneration reflects the generation of the most
                  recently observed Infra.
                format: int64
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
